// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  name          String?
  username      String?  @unique
  image         String?
  emailVerified DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Authentication
  accounts Account[]
  sessions Session[]

  // Profile
  bio         String?
  followers   Int      @default(0)
  following   Int      @default(0)
  totalViews  Int      @default(0)
  totalLikes  Int      @default(0)

  // Content
  videos  Video[]
  shorts  Short[]
  stories Story[]

  // Engagement
  likes      Like[]
  comments   Comment[]
  follows    Follow[] @relation("UserFollows")
  followersRelation Follow[] @relation("UserFollowers")

  // Monetization
  creatorProfile CreatorProfile?
  wallet         Wallet?
  earnings       Earning[]
  adCampaigns    AdCampaign[]

  // Activity
  watchHistory    WatchHistory[]
  searchQueries   SearchQuery[]
  recommendations Recommendation[]

  // Messaging
  sentMessages     Message[] @relation("Sender")
  receivedMessages Message[] @relation("Receiver")

  @@index([email])
  @@index([username])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  videoUrl    String
  thumbnailUrl String?
  duration    Int      // in seconds
  views       Int      @default(0)
  likes       Int      @default(0)
  comments    Int      @default(0)
  shares      Int      @default(0)
  watchTime   Int      @default(0) // total watch time in seconds
  category    String?
  tags        String?  // JSON array of tags
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Engagement
  likeUsers    Like[]
  commentsList Comment[]
  watchHistory WatchHistory[]

  // Monetization
  adPlacements AdPlacement[]
  earnings     Earning[]

  @@index([userId])
  @@index([createdAt])
  @@index([views])
}

model Short {
  id          String   @id @default(cuid())
  title       String
  description String?
  videoUrl    String
  thumbnailUrl String?
  duration    Int      // max 60 seconds
  views       Int      @default(0)
  likes       Int      @default(0)
  comments    Int      @default(0)
  shares      Int      @default(0)
  watchTime   Int      @default(0)
  category    String?
  tags        String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  likeUsers    Like[]
  commentsList Comment[]
  watchHistory WatchHistory[]
  adPlacements AdPlacement[]
  earnings     Earning[]

  @@index([userId])
  @@index([createdAt])
}

model Story {
  id          String   @id @default(cuid())
  mediaUrl    String
  thumbnailUrl String?
  duration    Int      // max 15 seconds
  views       Int      @default(0)
  expiresAt   DateTime // 24 hours from creation
  createdAt   DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  adPlacements AdPlacement[]
  earnings     Earning[]

  @@index([userId])
  @@index([expiresAt])
}

model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  videoId String?
  video   Video? @relation(fields: [videoId], references: [id], onDelete: Cascade)

  shortId String?
  short   Short? @relation(fields: [shortId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@unique([userId, shortId])
  @@index([userId])
  @@index([videoId])
  @@index([shortId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  videoId String?
  video   Video? @relation(fields: [videoId], references: [id], onDelete: Cascade)

  shortId String?
  short   Short? @relation(fields: [shortId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([videoId])
  @@index([shortId])
}

model Follow {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  followerId String
  follower   User    @relation("UserFollows", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User    @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model CreatorProfile {
  id                String   @id @default(cuid())
  isVerified        Boolean  @default(false)
  isMonetized       Boolean  @default(false)
  governmentId      String?  // encrypted or file path
  phoneVerified     Boolean  @default(false)
  phoneNumber       String?
  payoutMethod      String?  // bank, paystack, crypto, stripe
  payoutDetails     String?  // JSON with payment details
  verificationStatus String  @default("pending") // pending, approved, rejected
  verifiedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Wallet {
  id        String   @id @default(cuid())
  balance   Float    @default(0)
  totalEarned Float  @default(0)
  totalWithdrawn Float @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactions Transaction[]

  @@index([userId])
}

model Transaction {
  id          String   @id @default(cuid())
  type        String   // deposit, withdrawal, earning, ad_payment
  amount      Float
  status      String   // pending, completed, failed
  paymentMethod String? // paystack, stripe, crypto, bank
  paymentDetails String? // JSON with transaction details
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
  @@index([status])
}

model Earning {
  id          String   @id @default(cuid())
  amount      Float
  source      String   // video_view, ad_click, watch_time, subscription
  description String?
  createdAt   DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  videoId String?
  video   Video? @relation(fields: [videoId], references: [id], onDelete: Cascade)

  shortId String?
  short   Short? @relation(fields: [shortId], references: [id], onDelete: Cascade)

  storyId String?
  story   Story? @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model AdPlacement {
  id        String   @id @default(cuid())
  adType    String   // pre_roll, mid_roll, post_roll
  position  Int?     // for mid_roll, position in seconds
  createdAt DateTime @default(now())

  videoId String?
  video   Video? @relation(fields: [videoId], references: [id], onDelete: Cascade)

  shortId String?
  short   Short? @relation(fields: [shortId], references: [id], onDelete: Cascade)

  storyId String?
  story   Story? @relation(fields: [storyId], references: [id], onDelete: Cascade)

  campaignId String
  campaign   AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([videoId])
  @@index([shortId])
}

model AdCampaign {
  id              String   @id @default(cuid())
  title           String
  description     String?
  adVideoUrl      String
  thumbnailUrl    String?
  duration        Int      // 15 or 30 seconds
  budget          Float
  spent           Float    @default(0)
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  watchThroughRate Float   @default(0)
  status          String   @default("pending") // pending, active, paused, completed, rejected
  targetDemographics String? // JSON
  targetInterests String? // JSON
  targetCategories String? // JSON
  complianceStatus String  @default("pending") // pending, approved, rejected
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  startDate       DateTime?
  endDate         DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  placements AdPlacement[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model WatchHistory {
  id        String   @id @default(cuid())
  watchTime Int      // seconds watched
  completed Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  videoId String?
  video   Video? @relation(fields: [videoId], references: [id], onDelete: Cascade)

  shortId String?
  short   Short? @relation(fields: [shortId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@unique([userId, shortId])
  @@index([userId])
  @@index([videoId])
  @@index([shortId])
  @@index([createdAt])
}

model SearchQuery {
  id        String   @id @default(cuid())
  query     String
  keywords  String?  // extracted keywords JSON
  createdAt DateTime @default(now())

  userId String?
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([query])
}

model Recommendation {
  id        String   @id @default(cuid())
  score     Float
  reason    String?  // why this was recommended
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  videoId String?
  video   Video? @relation(fields: [videoId], references: [id], onDelete: Cascade)

  shortId String?
  short   Short? @relation(fields: [shortId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([score])
}

model Message {
  id        String   @id @default(cuid())
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  senderId String
  sender   User   @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId String
  receiver   User   @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

